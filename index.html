<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TREASURE BOOK - Final Fixed 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root { --navy: #060b26; --gold: #b8860b; }
        body { font-family: 'Inter', sans-serif; background: #020512; margin: 0; padding: 10px; color: #333; }

        /* UI Styles (Desktop/Mobile View) */
        .no-print-container { width: 100%; max-width: 1000px; margin: auto; background: #fff; border-radius: 20px; padding: 20px; box-sizing: border-box; }
        .brand-header { text-align: center; border-bottom: 2px solid var(--navy); margin-bottom: 20px; padding-bottom: 10px; }
        .stats { display: flex; gap: 10px; margin: 20px 0; }
        .card { flex: 1; padding: 15px; border-radius: 10px; color: #fff; text-align: center; font-weight: bold; }
        .bg-blue { background: #060b26; } .bg-red { background: #7f1d1d; } .bg-green { background: #064e3b; }
        
        .entry-section { background: #f4f7f9; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .btn-main { background: var(--navy); color: #fff; border: none; padding: 12px; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #eee; padding: 10px; text-align: left; font-size: 12px; }
        td { padding: 10px; border-bottom: 1px solid #ddd; font-size: 13px; }
        .act-btn { border: none; padding: 5px 10px; border-radius: 4px; color: #fff; cursor: pointer; margin-right: 5px; }
        .btn-del { background: #f87171; } .btn-edit { background: #38bdf8; } .btn-bill { background: var(--gold); }

        /* --- ðŸš€ PRINT LOGIC (FIXED) --- */
        #printArea { display: none; }

        @media print {
            /* Screen ki har cheez ko force hide karein */
            body * { display: none !important; }
            
            /* Print Area ko reset karein */
            #printArea, #printArea * { display: block !important; visibility: visible !important; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; background: white !important; color: black !important; }

            .ledger-container { padding: 20px; background: white !important; }
            .ledger-border { border: 2px solid #000; padding: 20px; min-height: 270mm; position: relative; }
            .print-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
            .print-header h1 { margin: 0; font-size: 24px; color: black !important; }
            
            .print-table { width: 100%; border-collapse: collapse; border: 1px solid #000; display: table !important; }
            .print-table th { background: #f0f0f0 !important; border: 1px solid #000; padding: 10px; color: black !important; -webkit-print-color-adjust: exact; }
            .print-table td { border: 1px solid #000; padding: 8px; font-size: 13px; color: black !important; font-weight: bold; }

            .summary-box { margin-top: 20px; border: 2px solid #000; display: flex; justify-content: space-around; padding: 15px; background: #f9f9f9 !important; -webkit-print-color-adjust: exact; }
            .signature-row { margin-top: 80px; display: flex; justify-content: space-between; }
            .sig-line { width: 200px; border-top: 2px solid #000; text-align: center; padding-top: 5px; font-weight: bold; color: black !important; }

            /* Receipt Logic */
            .receipt-card { border: 2px solid #000; padding: 20px; width: 600px; margin: 50px auto; background: white !important; }
            .amt-box { border: 2px solid #000; padding: 15px; font-size: 24px; font-weight: 900; margin: 20px 0; display: inline-block; color: black !important; }
        }
    </style>
</head>
<body>

<div class="no-print-container">
    <div class="year-control-nano" style="text-align:right">YR <select id="yearFilter" onchange="loadView()"></select></div>
    <div class="brand-header">
        <h1>TREASURE BOOK</h1>
        <h2>B.B.C MARANG BUNDU</h2>
        <p>Reg.no :- MBJ8750 - 13 Of 2022</p>
    </div>

    <div class="entry-section">
        <div class="form-grid">
            <input type="hidden" id="editKey">
            <input type="hidden" id="editDataType">
            <select id="eType" onchange="handleFormChange()"><option value="donation">CREDIT</option><option value="expense">DEBIT</option></select>
            <input type="date" id="eDate">
            <input type="text" id="eName" placeholder="Full Name / Particulars">
            <select id="eOcc">
                <option value="">Occupation</option>
                <option value="Farmer">Farmer</option><option value="Teacher">Teacher</option>
                <option value="Police">Police</option><option value="Army">Army</option>
                <option value="Railway">Railway</option><option value="Student">Student</option>
                <option value="Other">Other</option>
            </select>
            <input type="number" id="eAmount" placeholder="Amount â‚¹">
        </div>
        <button class="btn-main" id="saveBtn" onclick="saveEntry()">CONFIRM TRANSACTION</button>
    </div>

    <div class="stats">
        <div class="card bg-blue">COLLECTION: <span id="sumIn">0</span></div>
        <div class="card bg-red">EXPENSE: <span id="sumOut">0</span></div>
        <div class="card bg-green">BALANCE: <span id="sumBal">0</span></div>
    </div>

    <div class="list-section">
        <h3>ðŸ’° CREDIT LEDGER <button onclick="printReport('don')" style="float:right">Print</button></h3>
        <table id="tblDon"><thead><tr><th>Date</th><th>Name</th><th>Occ</th><th>Amt</th><th>Action</th></tr></thead><tbody id="bodyDon"></tbody></table>
    </div>

    <div class="list-section">
        <h3>ðŸ“‰ DEBIT LEDGER <button onclick="printReport('exp')" style="float:right">Print</button></h3>
        <table id="tblExp"><thead><tr><th>Date</th><th>Particulars</th><th>Amt</th><th>Action</th></tr></thead><tbody id="bodyExp"></tbody></table>
    </div>
</div>

<div id="printArea"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA_xB865cARTIZI5XFj7SMaA3c_xPfaDpc",
        authDomain: "treasure-books-a655d.firebaseapp.com",
        databaseURL: "https://treasure-books-a655d-default-rtdb.firebaseio.com",
        projectId: "treasure-books-a655d",
        storageBucket: "treasure-books-a655d.firebasestorage.app",
        messagingSenderId: "543411661924",
        appId: "1:543411661924:web:e87cdddfa8e839b47a8371"
    };
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database();
    let currentData = { donations: {}, expenses: {} };

    function formatDate(d) { if(!d) return "-"; const [y, m, d1] = d.split('-'); return `${d1}/${m}/${y}`; }

    dbRef.ref().on('value', (snap) => {
        const val = snap.val() || {};
        currentData.donations = val.donations || {};
        currentData.expenses = val.expenses || {};
        loadView();
    });

    function loadView() {
        const y = document.getElementById('yearFilter').value;
        let bD = document.getElementById('bodyDon'), bE = document.getElementById('bodyExp');
        let tIn = 0, tOut = 0; bD.innerHTML = ''; bE.innerHTML = '';
        
        Object.entries(currentData.donations).forEach(([k, x]) => {
            if(x.year == y) {
                bD.innerHTML += `<tr><td>${formatDate(x.date)}</td><td>${x.name}</td><td>${x.occ}</td><td>â‚¹${x.amt}</td><td><button class="act-btn btn-bill" onclick="printReceipt('${k}')">Bill</button><button class="act-btn btn-del" onclick="deleteEntry('don', '${k}')">X</button></td></tr>`;
                tIn += x.amt;
            }
        });
        Object.entries(currentData.expenses).forEach(([k, x]) => {
            if(x.year == y) {
                bE.innerHTML += `<tr><td>${formatDate(x.date)}</td><td>${x.name}</td><td>â‚¹${x.amt}</td><td><button class="act-btn btn-del" onclick="deleteEntry('exp', '${k}')">X</button></td></tr>`;
                tOut += x.amt;
            }
        });
        document.getElementById('sumIn').innerText = tIn; document.getElementById('sumOut').innerText = tOut; document.getElementById('sumBal').innerText = (tIn - tOut);
    }

    function saveEntry() {
        const type = document.getElementById('eType').value, date = document.getElementById('eDate').value, name = document.getElementById('eName').value, amt = parseFloat(document.getElementById('eAmount').value), occ = document.getElementById('eOcc').value;
        if(!date || !name || isNaN(amt)) return alert("Fill data!");
        dbRef.ref(type === 'donation' ? 'donations/' : 'expenses/').push({ date, name, occ, amt, year: new Date(date).getFullYear() });
        document.getElementById('eName').value = ''; document.getElementById('eAmount').value = '';
    }

    function deleteEntry(t, k) { if(confirm("Delete?")) dbRef.ref((t==='don'?'donations/':'expenses/')+k).remove(); }

    // --- ðŸ–¨ï¸ PRINTING FUNCTIONS ---
    function printReport(type) {
        const year = document.getElementById('yearFilter').value;
        const title = type === 'don' ? "CREDIT LEDGER (COLLECTION)" : "DEBIT LEDGER (EXPENDITURE)";
        let rows = ""; let data = type === 'don' ? currentData.donations : currentData.expenses;
        
        Object.values(data).filter(x => x.year == year).forEach((x, i) => { 
            rows += `<tr><td>${i+1}</td><td>${formatDate(x.date)}</td><td>${x.name}</td>${type==='don'?`<td>${x.occ}</td>`:''}<td>â‚¹${x.amt}</td></tr>`; 
        });

        document.getElementById('printArea').innerHTML = `
        <div class="ledger-container"><div class="ledger-border">
            <div class="print-header"><h1>B.B.C MARANG BUNDU</h1><h2>${title} - ${year}</h2></div>
            <table class="print-table">
                <thead>${type==='don'?'<tr><th>Sl</th><th>Date</th><th>Name</th><th>Occ</th><th>Amt</th></tr>':'<tr><th>Sl</th><th>Date</th><th>Particulars</th><th>Amt</th></tr>'}</thead>
                <tbody>${rows}</tbody>
            </table>
            <div class="summary-box"><b>TOTAL: â‚¹${type==='don'? document.getElementById('sumIn').innerText : document.getElementById('sumOut').innerText}</b></div>
            <div class="signature-row"><div class="sig-line">General Secretary</div><div class="sig-line">Principal Treasurer</div></div>
        </div></div>`;
        window.print();
    }

    function printReceipt(k) {
        const x = currentData.donations[k];
        document.getElementById('printArea').innerHTML = `
        <div class="receipt-card">
            <div class="print-header"><h1>B.B.C MARANG BUNDU</h1><p>DONATION RECEIPT</p></div>
            <p><b>Donor Name:</b> ${x.name}</p>
            <p><b>Date:</b> ${formatDate(x.date)} | <b>Occupation:</b> ${x.occ}</p>
            <div class="amt-box">â‚¹ ${x.amt}/-</div>
            <div class="signature-row"><div class="sig-line" style="margin-left:auto">Principal Treasurer</div></div>
        </div>`;
        window.print();
    }

    function buildYearDropdown() { const s = document.getElementById('yearFilter'); for(let i=2024; i<=2030; i++) { let o = document.createElement('option'); o.value=i; o.text=i; if(i==new Date().getFullYear()) o.selected=true; s.appendChild(o); } }
    function handleFormChange() { document.getElementById('eOcc').style.display = (document.getElementById('eType').value === 'donation' ? 'inline-block' : 'none'); }
    window.onload = () => { buildYearDropdown(); document.getElementById('eDate').valueAsDate = new Date(); handleFormChange(); };
</script>
</body>
</html>
