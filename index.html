<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TREASURE BOOKS | FINAL STABLE</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Outfit:wght@300;400;600;900&family=Dancing+Script:wght@700&family=Crimson+Text:ital,wght@1,600&display=swap');

        :root {
            --bg: #05080a; --glass: rgba(10, 15, 25, 0.88);
            --gold: #eab308; --neon-teal: #06b6d4;
            --green: #10b981; --red: #f43f5e; --border: rgba(234, 179, 8, 0.15);
        }

        body { 
            margin: 0; font-family: 'Outfit', sans-serif; 
            background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.unsplash.com/photo-1507679799987-c73779587ccf?q=80&w=2071&auto=format&fit=crop');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: #f8fafc; min-height: 100vh; 
        }

        /* --- DASHBOARD UI --- */
        .dash-header { text-align: center; padding: 40px 20px 10px; }
        .main-title { font-family: 'Cinzel', serif; font-size: 52px; font-weight: 900; letter-spacing: 8px; margin: 0; background: linear-gradient(to bottom, #fde68a, #b45309); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .year-bg-pin { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--gold); padding: 12px 35px; border-radius: 50px; width: fit-content; margin: 25px auto; backdrop-filter: blur(15px); display: flex; align-items: center; gap: 15px; }
        .year-bg-pin select { background: transparent; border: none; color: #fff; font-weight: 900; font-size: 18px; outline: none; cursor: pointer; }

        .treasurer-config { display: flex; justify-content: center; gap: 20px; margin: 25px auto; }
        .t-box { background: var(--glass); border: 1px solid var(--border); padding: 12px 20px; border-radius: 15px; text-align: center; }
        .t-box label { font-size: 10px; color: var(--gold); text-transform: uppercase; display: block; margin-bottom: 5px; font-weight: 900; }
        .t-box input { background: transparent; border: none; border-bottom: 1.5px solid var(--gold); color: #fff; text-align: center; font-family: 'Cinzel'; font-weight: 900; font-size: 15px; outline: none; width: 200px; }

        .stats-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; max-width: 1100px; margin: 30px auto; width: 95%; }
        .stat-card { background: var(--glass); padding: 30px; border-radius: 28px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 36px; font-weight: 900; font-family: 'Cinzel'; margin-top: 10px; }

        .form-box { background: var(--glass); padding: 35px; border-radius: 35px; border: 1px solid var(--border); max-width: 850px; margin: 30px auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 18px; }
        .form-grid input, .form-grid select { background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); color: white; padding: 14px; border-radius: 14px; outline: none; }
        .btn-save { grid-column: span 3; background: linear-gradient(135deg, #fbbf24, #d97706); color: #000; border: none; padding: 18px; border-radius: 15px; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }

        .lists-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; max-width: 1300px; margin: 40px auto; padding: 0 20px; }
        .ledger-box { background: var(--glass); padding: 25px; border-radius: 25px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: var(--gold); padding: 12px; border-bottom: 2.5px solid var(--border); font-weight: 900; }
        td { padding: 14px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .btn-mini { padding: 7px 12px; border-radius: 8px; cursor: pointer; border: 1px solid #444; background: #000; color: #fff; font-size: 11px; margin-right: 5px; }

        /* --- EDIT MODAL --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { background: #0f172a; padding: 35px; border-radius: 25px; border: 1.5px solid var(--gold); width: 380px; }

        /* --- PRINT AREA --- */
        #printArea { display: none; }

        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white !important; color: black !important; }
            
            /* Portrait Fix (Ledger) */
            .portrait-wrap { width: 100%; padding: 10mm; background: white; min-height: 290mm; box-sizing: border-box; display: flex; flex-direction: column; position: relative; }
            
            /* Landscape Fix (Receipt) */
            .landscape-wrap { width: 297mm; height: 210mm; display: flex; align-items: center; justify-content: center; background: white; }
            .receipt-card { width: 250mm; height: 160mm; border: 8px double #000; padding: 40px; display: flex; flex-direction: column; justify-content: space-between; box-sizing: border-box; }

            .print-h1 { font-family: 'Cinzel'; font-size: 38px; font-weight: 900; margin: 0; }
            .receipt-hl { background: black !important; color: white !important; padding: 10px 60px; font-size: 28px; display: inline-block; margin: 15px 0; -webkit-print-color-adjust: exact; }
            .amount-hl { border: 6px double #000; padding: 15px 50px; font-size: 48px; font-weight: 900; background: #f2f2f2 !important; -webkit-print-color-adjust: exact; display: inline-block; margin: 10px 0; }
            .ink-field { font-family: 'Crimson Text'; font-style: italic; font-size: 24px; border-bottom: 1.5px dotted #000; padding: 0 10px; }

            .report-table { width: 100%; border-collapse: collapse; margin: 20px 0; border: 2.5px solid #000; }
            .report-table th, .report-table td { border: 1px solid #000; padding: 10px; text-align: left; }
            .report-summary { display: grid; grid-template-columns: repeat(3, 1fr); border: 3px solid #000; background: #f9f9f9 !important; -webkit-print-color-adjust: exact; font-weight: 900; }
            .report-summary div { padding: 15px; text-align: center; border-right: 1.5px solid #000; }
            
            .sig-row { display: flex; justify-content: space-between; margin-top: auto; padding: 50px 20px 20px; }
            .sig-box { text-align: center; width: 250px; }
            .sig-font { font-family: 'Dancing Script', cursive; font-size: 40px; display: block; height: 45px; }
            .sig-line { border-top: 2px solid #000; padding-top: 5px; font-weight: 900; font-size: 13px; text-transform: uppercase; }
            .system-tag { position: absolute; bottom: 10mm; left: 0; width: 100%; text-align: center; font-size: 12px; font-style: italic; border-top: 1px solid #ddd; padding-top: 5px; }
        }
    </style>
</head>
<body>

<div class="dash-header no-print">
    <h1 class="main-title">TREASURE BOOKS</h1>
    <div class="sub-title">B.B.C MARANG BUNDU</div>
    <div class="reg-no">Reg.no :- MBJ8750 - 13 Of 2022</div>
</div>

<div class="year-bg-pin no-print">
    <label style="color:var(--gold)">SESSION YEAR :</label>
    <select id="yearFilter" onchange="loadView()"></select>
</div>

<div class="treasurer-config no-print">
    <div class="t-box"><label>Principal Treasurer</label><input type="text" id="cfgT" placeholder="Name" onchange="updateCfg()"></div>
    <div class="t-box"><label>Assistant Treasurer</label><input type="text" id="cfgAT" placeholder="Name" onchange="updateCfg()"></div>
</div>

<div class="stats-container no-print">
    <div class="stat-card"><div style="color:var(--green); font-weight:900;">COLLECTIONS</div><div class="stat-val" id="sumIn" style="color:var(--green)">‚Çπ 0</div></div>
    <div class="stat-card"><div style="color:var(--red); font-weight:900;">EXPENDITURES</div><div class="stat-val" id="sumOut" style="color:var(--red)">‚Çπ 0</div></div>
    <div class="stat-card"><div style="color:var(--gold); font-weight:900;">BALANCE</div><div class="stat-val" id="sumBal" style="color:var(--gold)">‚Çπ 0</div></div>
</div>

<div class="form-box no-print">
    <div class="form-grid">
        <select id="eType" style="grid-column: span 3;"><option value="donation">‚ú® CREDIT (Collection)</option><option value="expense">üõ°Ô∏è DEBIT (Expenditure)</option></select>
        <input type="date" id="eDate">
        <input type="number" id="eAmount" placeholder="Amount ‚Çπ">
        <input type="text" id="eName" placeholder="Name / Purpose">
        <button class="btn-save" onclick="saveEntry()">Save Transaction</button>
    </div>
</div>

<div class="lists-container no-print">
    <div class="ledger-box">
        <h3 style="color:var(--green); display:flex; justify-content:space-between;">Collections <button class="btn-mini" onclick="printReport('don')">Report</button></h3>
        <table><thead><tr><th>Date</th><th>Donor</th><th>Amount</th><th>Action</th></tr></thead><tbody id="bodyDon"></tbody></table>
    </div>
    <div class="ledger-box">
        <h3 style="color:var(--red); display:flex; justify-content:space-between;">Expenditures <button class="btn-mini" onclick="printReport('exp')">Report</button></h3>
        <table><thead><tr><th>Date</th><th>Purpose</th><th>Amount</th><th>Action</th></tr></thead><tbody id="bodyExp"></tbody></table>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--gold); margin-top:0; font-family:Cinzel;">‚úèÔ∏è Edit Entry</h3>
        <input type="hidden" id="editKey"><input type="hidden" id="editType">
        <div style="display:flex; flex-direction:column; gap:15px;">
            <input type="date" id="mDate" style="padding:12px; border-radius:10px; border:1px solid #444; background:#05080a; color:white;">
            <input type="text" id="mName" placeholder="Name" style="padding:12px; border-radius:10px; border:1px solid #444; background:#05080a; color:white;">
            <input type="number" id="mAmount" placeholder="Amount" style="padding:12px; border-radius:10px; border:1px solid #444; background:#05080a; color:white;">
            <button class="btn-save" onclick="updateData()">Update</button>
            <button onclick="closeModal()" style="color:#94a3b8; background:none; border:none; cursor:pointer;">Cancel</button>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA_xB865cARTIZI5XFj7SMaA3c_xPfaDpc",
        authDomain: "treasure-books-a655d.firebaseapp.com",
        databaseURL: "https://treasure-books-a655d-default-rtdb.firebaseio.com",
        projectId: "treasure-books-a655d",
        storageBucket: "treasure-books-a655d.firebasestorage.app",
        messagingSenderId: "543411661924",
        appId: "1:543411661924:web:e87cdddfa8e839b47a8371"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let localData = { donations: {}, expenses: {}, config: { tName: "", atName: "" } };

    db.ref().on('value', snap => {
        const v = snap.val() || {};
        localData.donations = v.donations || {};
        localData.expenses = v.expenses || {};
        if(v.config) {
            localData.config = v.config;
            document.getElementById('cfgT').value = v.config.tName || "";
            document.getElementById('cfgAT').value = v.config.atName || "";
        }
        loadView();
    });

    function updateCfg() {
        db.ref('config').update({ tName: document.getElementById('cfgT').value, atName: document.getElementById('cfgAT').value });
    }

    function numToWords(n) {
        const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
        const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const format = (num) => {
            if (num == 0) return '';
            if (num < 20) return a[num];
            if (num < 100) return b[Math.floor(num / 10)] + (num % 10 !== 0 ? ' ' + a[num % 10] : '');
            if (num < 1000) return a[Math.floor(num / 100)] + ' Hundred ' + (num % 100 !== 0 ? 'and ' + format(num % 100) : '');
            if (num < 100000) return format(Math.floor(num / 1000)) + ' Thousand ' + (num % 1000 !== 0 ? format(num % 1000) : '');
            if (num < 10000000) return format(Math.floor(num / 100000)) + ' Lakh ' + (num % 100000 !== 0 ? format(num % 100000) : '');
            return format(Math.floor(num / 10000000)) + ' Crore ' + (num % 10000000 !== 0 ? format(num % 10000000) : '');
        }
        return n == 0 ? 'Zero Only' : format(n) + 'Only';
    }

    function loadView() {
        const fy = document.getElementById('yearFilter').value;
        const bD = document.getElementById('bodyDon'), bE = document.getElementById('bodyExp');
        let tin = 0, tout = 0; bD.innerHTML = ''; bE.innerHTML = '';
        Object.entries(localData.donations).forEach(([k, x]) => {
            if(x.year == fy) { tin += Number(x.amt); bD.innerHTML += `<tr><td>${x.date}</td><td>${x.name}</td><td>‚Çπ${Number(x.amt).toLocaleString()}</td><td><button class="btn-mini" onclick="printReceipt('${k}')">Bill</button> <button class="btn-mini" onclick="openEditModal('donation','${k}')">‚úèÔ∏è</button> <button class="btn-mini" onclick="deleteEntry('donations','${k}')">üóëÔ∏è</button></td></tr>`; }
        });
        Object.entries(localData.expenses).forEach(([k, x]) => {
            if(x.year == fy) { tout += Number(x.amt); bE.innerHTML += `<tr><td>${x.date}</td><td>${x.name}</td><td>‚Çπ${Number(x.amt).toLocaleString()}</td><td><button class="btn-mini" onclick="openEditModal('expense','${k}')">‚úèÔ∏è</button> <button class="btn-mini" onclick="deleteEntry('expenses','${k}')">üóëÔ∏è</button></td></tr>`; }
        });
        document.getElementById('sumIn').innerText = '‚Çπ ' + tin.toLocaleString();
        document.getElementById('sumOut').innerText = '‚Çπ ' + tout.toLocaleString();
        document.getElementById('sumBal').innerText = '‚Çπ ' + (tin - tout).toLocaleString();
    }

    function saveEntry() {
        const t = document.getElementById('eType').value, d = document.getElementById('eDate').value, n = document.getElementById('eName').value, a = document.getElementById('eAmount').value;
        if(!d || !n || !a) return alert("Pura data bharein!");
        db.ref(t === 'donation' ? 'donations/' : 'expenses/').push({ date: d, name: n, amt: Number(a), year: new Date(d).getFullYear() });
        document.getElementById('eName').value = ''; document.getElementById('eAmount').value = '';
    }

    function openEditModal(t, k) {
        const d = t === 'donation' ? localData.donations[k] : localData.expenses[k];
        document.getElementById('editKey').value = k; document.getElementById('editType').value = t;
        document.getElementById('mDate').value = d.date; document.getElementById('mName').value = d.name; document.getElementById('mAmount').value = d.amt;
        document.getElementById('editModal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('editModal').style.display = 'none'; }
    function updateData() {
        const k = document.getElementById('editKey').value, t = document.getElementById('editType').value;
        db.ref((t === 'donation' ? 'donations/' : 'expenses/') + k).update({ date: document.getElementById('mDate').value, name: document.getElementById('mName').value, amt: Number(document.getElementById('mAmount').value), year: new Date(document.getElementById('mDate').value).getFullYear() });
        closeModal();
    }

    function deleteEntry(p, k) { if(confirm("Permanently Delete?")) db.ref(p + '/' + k).remove(); }

    function printReceipt(key) {
        const item = localData.donations[key]; const words = numToWords(item.amt);
        const style = document.createElement('style'); style.innerHTML = "@page { size: landscape; margin: 0; }"; document.head.appendChild(style);
        document.getElementById('printArea').innerHTML = `
            <div class="landscape-wrap">
                <div class="receipt-card">
                    <center>
                        <h1 class="print-h1">52nd SAHID DIWAS 2026</h1>
                        <h2 style="font-family:Cinzel; font-size:24px; margin:5px 0;">B.B.C MARANG BUNDU</h2>
                        <div style="font-weight:bold; font-size:14px;">Reg.no :- MBJ8750 - 13 Of 2022</div>
                        <div class="receipt-hl">DONATION RECEIPT</div>
                    </center>
                    <div style="display:flex; justify-content:space-between; margin:20px 0; font-size:20px; font-weight:bold;">
                        <span>Receipt No: <span class="ink-field">#${key.substr(-5).toUpperCase()}</span></span>
                        <span>Date: <span class="ink-field">${item.date}</span></span>
                    </div>
                    <div style="font-size:22px; line-height:2.8; font-family:'Crimson Text', serif;">
                        Received with thanks from Mr./Ms. <span class="ink-field" style="min-width:450px; display:inline-block;">${item.name}</span> <br>
                        The sum of Rupees <span class="ink-field" style="min-width:550px; text-transform:capitalize; display:inline-block;">${words}</span> <br>
                        Towards <span class="ink-field" style="min-width:550px; display:inline-block;">52nd Sahid Diwas Celebration Fund</span>.
                    </div>
                    <center><div class="amount-hl">‚Çπ ${Number(item.amt).toLocaleString()} /-</div></center>
                    <div style="margin-top:auto;">
                        <div style="text-align:center; border-top:1px dashed #000; padding-top:15px;">
                            <p style="font-style:italic; font-size:16px;">"Thank you for your contribution towards Sahid Diwas."</p>
                            <b style="font-size:22px; letter-spacing:5px;">THANK YOU!</b>
                        </div>
                        <div style="display:flex; justify-content:flex-end;">
                            <div class="sig-box">
                                <span class="sig-font">${localData.config.tName}</span>
                                <div class="sig-line">Principal Treasurer</div>
                                <div style="font-size:11px; font-weight:bold;">B.B.C MARANG BUNDU</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        window.print(); style.remove();
    }

    function printReport(type) {
        const fy = document.getElementById('yearFilter').value; let tin = 0, tout = 0;
        const style = document.createElement('style'); style.innerHTML = "@page { size: portrait; margin: 0; }"; document.head.appendChild(style);
        const rows = Object.values(type === 'don' ? localData.donations : localData.expenses).filter(x => x.year == fy).map((x, i) => `<tr><td>${i+1}</td><td>${x.date}</td><td>${x.name}</td><td>‚Çπ ${Number(x.amt).toLocaleString()}</td></tr>`).join('');
        Object.values(localData.donations).filter(x => x.year == fy).forEach(x => tin += Number(x.amt));
        Object.values(localData.expenses).filter(x => x.year == fy).forEach(x => tout += Number(x.amt));

        document.getElementById('printArea').innerHTML = `
            <div class="portrait-wrap">
                <center>
                    <h1 class="print-h1" style="font-size:32px;">52nd SAHID DIWAS 2026</h1>
                    <h2 style="font-family:Cinzel; font-size:24px; margin:5px 0;">B.B.C MARANG BUNDU</h2>
                    <div style="font-weight:bold; font-size:14px;">Reg.no :- MBJ8750 - 13 Of 2022</div>
                    <div style="background:black !important; color:white !important; padding:8px 40px; font-weight:900; margin:15px 0; -webkit-print-color-adjust: exact; text-transform:uppercase;">${type === 'don' ? 'COLLECTION' : 'EXPENDITURE'} LEDGER REPORT</div>
                    <div style="font-weight:bold; margin-bottom:10px;">SESSION: ${fy}</div>
                </center>
                <table class="report-table">
                    <thead><tr style="background:#f2f2f2 !important; -webkit-print-color-adjust: exact;"><th>S.N</th><th>Date</th><th>Particulars</th><th>Amount (‚Çπ)</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="report-summary">
                    <div>TOTAL COLLECTIONS<br>‚Çπ ${tin.toLocaleString()}</div>
                    <div>TOTAL EXPENDITURES<br>‚Çπ ${tout.toLocaleString()}</div>
                    <div>NET BALANCE<br>‚Çπ ${(tin-tout).toLocaleString()}</div>
                </div>
                <div class="sig-row">
                    <div class="sig-box"><span class="sig-font">${localData.config.atName}</span><div class="sig-line">Assistant Treasurer</div></div>
                    <div class="sig-box"><span class="sig-font">${localData.config.tName}</span><div class="sig-line">Principal Treasurer</div></div>
                </div>
                <div class="system-tag">This is a system generated report by Treasure Books Elite</div>
            </div>`;
        window.print(); style.remove();
    }

    (function init() {
        const s = document.getElementById('yearFilter');
        for (let y = 2026; y <= 2050; y++) {
            let o = document.createElement('option'); o.value = y; o.text = "Session " + y;
            if(y === 2026) o.selected = true; s.appendChild(o);
        }
        document.getElementById('eDate').valueAsDate = new Date();
    })();
</script>
</body>
</html>
