<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TREASURE BOOK - Master Edition 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Dancing+Script:wght@600&display=swap');
        
        :root { 
            --navy: #060b26; --gold: #b8860b; --premium-gold: #ffd700; 
            --glass: rgba(255, 255, 255, 0.96);
        }
        
        body { 
            font-family: 'Inter', sans-serif; background: #020512;
            margin: 0; padding: 15px; color: #333; display: flex; justify-content: center;
        }

        /* --- UI Styles --- */
        .premium-frame {
            position: relative; width: 100%; max-width: 1100px; padding: 4px;
            background: linear-gradient(90deg, #060b26, #b8860b, #00d2ff, #b8860b, #060b26);
            background-size: 300% 300%; animation: glowRotate 8s linear infinite;
            border-radius: 40px;
        }
        @keyframes glowRotate { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        .container { 
            background: var(--glass); border-radius: 38px; padding: 40px; 
            position: relative; width: 100%; box-sizing: border-box;
        }
        
        .year-control-nano {
            position: absolute; top: 20px; right: 30px;
            background: var(--navy); color: var(--premium-gold); padding: 5px 12px;
            border-radius: 8px; font-weight: 900; border: 1px solid var(--gold);
        }
        .year-control-nano select { background: transparent; color: #fff; border: none; outline: none; cursor: pointer; }

        .brand-header { text-align: center; margin-bottom: 30px; }
        .brand-header h1 { color: var(--navy); font-size: 38px; letter-spacing: 5px; margin: 0; }
        .brand-header h2 { color: var(--gold); font-size: 22px; margin: 5px 0; }

        .executive-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .exec-card { background: #fff; padding: 15px; border-radius: 15px; border: 1.5px solid #e2e8f0; text-align: center; position: relative; }
        .exec-card span { font-size: 10px; color: #64748b; text-transform: uppercase; display: block; }
        .exec-card b { font-size: 18px; color: var(--navy); }
        .exec-edit { position: absolute; right: 10px; top: 10px; font-size: 10px; cursor: pointer; color: #ef4444; border: none; background: none; }

        .entry-section { background: #f8fafc; padding: 20px; border-radius: 20px; margin-bottom: 30px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        input, select { padding: 10px; border: 1.5px solid #cbd5e1; border-radius: 10px; outline: none; }
        .btn-save-compact { background: var(--navy); color: white; border: none; border-radius: 10px; padding: 12px 30px; font-weight: 900; cursor: pointer; margin: 15px auto 0; display: block; }

        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .card { padding: 15px; border-radius: 20px; color: white; text-align: center; font-weight: 900; }
        .bg-blue { background: #060b26; } .bg-red { background: #7f1d1d; } .bg-green { background: #064e3b; }

        .list-section { background: white; border-radius: 25px; padding: 20px; border: 1px solid #f1f5f9; margin-bottom: 25px; }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-print-icon { background: var(--navy); color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; border: 1px solid var(--gold); }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 11px; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; font-weight: 600; }
        .act-btn { border: none; padding: 6px 10px; border-radius: 6px; color: white; cursor: pointer; font-size: 10px; margin-right: 3px; }
        .btn-r { background: var(--gold); } .btn-edit { background: #38bdf8; } .btn-del { background: #f87171; }

        /* --- üõ†Ô∏è FIX: PRINT LOGIC (NO OVERLAY) --- */
        #printArea { display: none; }

        @media print {
            /* Hide everything on the screen */
            body * { visibility: hidden !important; }
            .no-print, .premium-frame, .container, body { background: white !important; padding: 0 !important; margin: 0 !important; }

            /* Show ONLY the print area */
            #printArea, #printArea * { visibility: visible !important; }
            #printArea { 
                display: block !important; 
                position: absolute !important; 
                left: 0 !important; 
                top: 0 !important; 
                width: 100% !important; 
                background: white !important;
            }

            .ledger-container { padding: 15mm; background: white; width: 100%; box-sizing: border-box; }
            .ledger-border { border: 2px solid #000; padding: 15px; min-height: 260mm; }
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .print-header h1 { font-size: 28px; margin: 0; }
            .print-type-label { font-size: 18px; font-weight: bold; text-decoration: underline; margin: 15px 0; display: block; text-align: center; }

            .print-table { width: 100%; border-collapse: collapse; border: 1px solid #000; }
            .print-table th { background: #eee !important; color: #000 !important; border: 1px solid #000; padding: 8px; font-size: 12px; -webkit-print-color-adjust: exact; }
            .print-table td { border: 1px solid #000; padding: 8px; font-size: 12px; color: #000; font-weight: bold; }

            .total-summary-print { 
                margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); 
                border: 2px solid #000; background: #f0f0f0 !important; padding: 10px; text-align: center; -webkit-print-color-adjust: exact;
            }
            .summary-item { font-weight: 900; font-size: 14px; }
            .signature-row { margin-top: 60px; display: flex; justify-content: space-between; }
            .sig-box-p { width: 200px; border-top: 1.5px solid #000; text-align: center; padding-top: 5px; font-weight: bold; }

            /* Receipt Styles */
            .receipt-centered { display: flex; justify-content: center; padding-top: 30mm; }
            .receipt-card { border: 2px solid #000; width: 600px; padding: 15px; }
            .receipt-inner { border: 4px double #000; padding: 20px; }
            .amt-box { border: 2px solid #000; padding: 10px 20px; font-size: 20px; font-weight: 900; margin: 15px 0; display: inline-block; }
        }
    </style>
</head>
<body>

<div class="premium-frame no-print">
    <div class="container">
        <div class="year-control-nano">YR <select id="yearFilter" onchange="loadView()"></select></div>
        <div class="brand-header">
            <h1>TREASURE BOOK</h1>
            <h2>B.B.C MARANG BUNDU</h2>
            <p>Reg.no :- MBJ8750 - 13 Of 2022</p>
        </div>
        
        <div class="executive-info">
            <div class="exec-card"><span>Principal Treasurer</span><b id="tName">...</b><button class="exec-edit" onclick="editMember('tName', 'tName')">Edit</button></div>
            <div class="exec-card"><span>Asst Treasurer</span><b id="atName">...</b><button class="exec-edit" onclick="editMember('atName', 'atName')">Edit</button></div>
        </div>

        <div class="entry-section">
            <div class="form-grid">
                <input type="hidden" id="editKey"><input type="hidden" id="editType">
                <select id="eType" onchange="handleFormChange()"><option value="donation">CREDIT (Collection)</option><option value="expense">DEBIT (Expenditure)</option></select>
                <input type="date" id="eDate">
                <input type="text" id="eName" placeholder="Full Name / Particulars">
                <select id="eOcc" onchange="checkExService()">
                    <option value="">Occupation</option>
                    <option value="Teacher">Teacher</option><option value="Police">Police</option><option value="Army">Army</option><option value="Railway">Railway</option><option value="Student">Student</option><option value="Farmer">Farmer</option><option value="Business">Business</option><option value="Ex-Service">Ex-Service</option><option value="Other">Other</option>
                </select>
                <select id="eSubOcc" style="display:none;"><option value="">Branch List</option><option value="Army">Army</option><option value="Police">Police</option><option value="Teacher">Teacher</option></select>
                <input type="text" id="eRecBy" placeholder="Received By" style="display:none;">
                <input type="number" id="eAmount" placeholder="Amount ‚Çπ">
            </div>
            <button class="btn-save-compact" id="saveBtn" onclick="saveEntry()">CONFIRM TRANSACTION</button>
        </div>

        <div class="stats">
            <div class="card bg-blue">COLLECTION <br><b id="sumIn">0</b></div>
            <div class="card bg-red">EXPENDITURE <br><b id="sumOut">0</b></div>
            <div class="card bg-green">NET BALANCE <br><b id="sumBal">0</b></div>
        </div>

        <div class="list-section">
            <div class="list-header"><b>üí∞ CREDIT LEDGER</b><button class="btn-print-icon" onclick="printReport('don')">‚éô Print</button></div>
            <table id="tblDon"><thead><tr><th>Sl</th><th>Date</th><th>Donor Name</th><th>Occupation</th><th>Amt</th><th>Action</th></tr></thead><tbody id="bodyDon"></tbody></table>
        </div>

        <div class="list-section">
            <div class="list-header"><b>üìâ DEBIT LEDGER</b><button class="btn-print-icon" onclick="printReport('exp')">‚éô Print</button></div>
            <table id="tblExp"><thead><tr><th>Sl</th><th>Date</th><th>Particulars</th><th>Amt</th><th>Action</th></tr></thead><tbody id="bodyExp"></tbody></table>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script>
    // Firebase Setup
    const firebaseConfig = {
        apiKey: "AIzaSyA_xB865cARTIZI5XFj7SMaA3c_xPfaDpc",
        authDomain: "treasure-books-a655d.firebaseapp.com",
        databaseURL: "https://treasure-books-a655d-default-rtdb.firebaseio.com",
        projectId: "treasure-books-a655d",
        storageBucket: "treasure-books-a655d.firebasestorage.app",
        messagingSenderId: "543411661924",
        appId: "1:543411661924:web:e87cdddfa8e839b47a8371"
    };
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database();
    let currentData = { donations: {}, expenses: {} };

    // Functions
    function formatDate(d) { if(!d) return "-"; const [y, m, d1] = d.split('-'); return `${d1}/${m}/${y}`; }
    
    function numberToWords(num) {
        const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
        const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
        let n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
        if (!n) return '';
        let str = '';
        str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
        str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
        str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
        str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
        str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + 'only' : '';
        return str;
    }

    function getSahidYear(y) { return `${y - 1974}th SAHID DIWAS ${y}`; }

    dbRef.ref().on('value', (snap) => {
        const val = snap.val() || {};
        currentData.donations = val.donations || {};
        currentData.expenses = val.expenses || {};
        document.getElementById('tName').innerText = val.config?.tName || "Treasurer";
        document.getElementById('atName').innerText = val.config?.atName || "Asst Treasurer";
        loadView();
    });

    function loadView() {
        const y = document.getElementById('yearFilter').value;
        let bD = document.getElementById('bodyDon'), bE = document.getElementById('bodyExp');
        let tIn = 0, tOut = 0; bD.innerHTML = ''; bE.innerHTML = '';
        
        Object.entries(currentData.donations).forEach(([k, x]) => {
            if(x.year == y) {
                bD.innerHTML += `<tr><td>#</td><td>${formatDate(x.date)}</td><td>${x.name}</td><td>${x.occ}</td><td>‚Çπ${x.amt}</td><td><button class="act-btn btn-r" onclick="printReceipt('${k}')">Bill</button><button class="act-btn btn-del" onclick="deleteEntry('don', '${k}')">X</button></td></tr>`;
                tIn += x.amt;
            }
        });
        Object.entries(currentData.expenses).forEach(([k, x]) => {
            if(x.year == y) {
                bE.innerHTML += `<tr><td>#</td><td>${formatDate(x.date)}</td><td>${x.name}</td><td>‚Çπ${x.amt}</td><td><button class="act-btn btn-del" onclick="deleteEntry('exp', '${k}')">X</button></td></tr>`;
                tOut += x.amt;
            }
        });
        document.getElementById('sumIn').innerText = tIn;
        document.getElementById('sumOut').innerText = tOut;
        document.getElementById('sumBal').innerText = (tIn - tOut);
    }

    function saveEntry() {
        const type = document.getElementById('eType').value, date = document.getElementById('eDate').value, name = document.getElementById('eName').value, amt = parseFloat(document.getElementById('eAmount').value), occ = document.getElementById('eOcc').value;
        if(!date || !name || isNaN(amt)) return alert("Data bhariye!");
        const entry = { date, name, occ: (type==='donation'?occ:'-'), amt, year: new Date(date).getFullYear() };
        dbRef.ref(type === 'donation' ? 'donations/' : 'expenses/').push(entry);
        document.getElementById('eName').value = ''; document.getElementById('eAmount').value = '';
    }

    function deleteEntry(t, k) { if(confirm("Delete?")) dbRef.ref((t==='don'?'donations/':'expenses/')+k).remove(); }

    function printReport(type) {
        const year = document.getElementById('yearFilter').value;
        const title = type === 'don' ? "CREDIT LEDGER (COLLECTION)" : "DEBIT LEDGER (EXPENDITURE)";
        let rows = ""; let data = type === 'don' ? currentData.donations : currentData.expenses;
        
        Object.values(data).filter(x => x.year == year).forEach((x, i) => { 
            rows += `<tr><td>${i+1}</td><td>${formatDate(x.date)}</td><td>${x.name}</td>${type==='don'?`<td>${x.occ}</td>`:''}<td>‚Çπ${x.amt}</td></tr>`; 
        });

        document.getElementById('printArea').innerHTML = `
        <div class="ledger-container"><div class="ledger-border">
            <div class="print-header"><h1>${getSahidYear(year)}</h1><h2>B.B.C MARANG BUNDU</h2><span class="print-type-label">${title}</span></div>
            <table class="print-table">
                <thead>${type==='don'?'<tr><th>Sl</th><th>Date</th><th>Donor Name</th><th>Occupation</th><th>Amount</th></tr>':'<tr><th>Sl</th><th>Date</th><th>Particulars</th><th>Amount</th></tr>'}</thead>
                <tbody>${rows}</tbody>
            </table>
            <div class="total-summary-print">
                <div class="summary-item">COLLECTION: ‚Çπ${document.getElementById('sumIn').innerText}</div>
                <div class="summary-item">EXPENSE: ‚Çπ${document.getElementById('sumOut').innerText}</div>
                <div class="summary-item">BALANCE: ‚Çπ${document.getElementById('sumBal').innerText}</div>
            </div>
            <div class="signature-row"><div class="sig-box-p">General Secretary</div><div class="sig-box-p">Principal Treasurer</div></div>
        </div></div>`;
        window.print();
    }

    function printReceipt(k) {
        const x = currentData.donations[k];
        document.getElementById('printArea').innerHTML = `
        <div class="receipt-centered"><div class="receipt-card"><div class="receipt-inner">
            <div class="print-header"><h1>${getSahidYear(x.year)}</h1><h2>B.B.C MARANG BUNDU</h2><br><b>DONATION RECEIPT</b></div>
            <p><b>Donor:</b> ${x.name} | <b>Date:</b> ${formatDate(x.date)}</p>
            <p><b>Occupation:</b> ${x.occ}</p>
            <div class="amt-box">‚Çπ ${x.amt}/-</div>
            <p><i>Rupees ${numberToWords(x.amt)} only</i></p>
            <div style="text-align:right; margin-top:30px;"><b>Principal Treasurer</b></div>
        </div></div></div>`;
        window.print();
    }

    function buildYearDropdown() { const s = document.getElementById('yearFilter'); for(let i=2024; i<=2030; i++) { let o = document.createElement('option'); o.value=i; o.text=i; if(i==new Date().getFullYear()) o.selected=true; s.appendChild(o); } }
    function editMember(id, f) { let v = prompt("New Name?"); if(v) dbRef.ref('config/'+f).set(v); }
    function checkExService() { document.getElementById('eSubOcc').style.display = (document.getElementById('eOcc').value === "Ex-Service" ? "inline-block" : "none"); }
    function handleFormChange() { const isD = document.getElementById('eType').value === 'donation'; document.getElementById('eOcc').style.display = isD ? "inline-block" : "none"; }
    window.onload = () => { buildYearDropdown(); document.getElementById('eDate').valueAsDate = new Date(); handleFormChange(); };
</script>
</body>
    </html>
